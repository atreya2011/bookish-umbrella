- name: Get DEB architecture
  shell: dpkg --print-architecture
  register: deb_architecture

- name: uname -s
  shell: uname -s
  register: unames

- name: Get the username running the playbook
  become: false
  shell: whoami
  register: username_on_host

- name: Docker - install apt package dependencies
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: latest
    update_cache: yes
  # https://github.com/ansible/ansible/issues/51663#issuecomment-650562476
  # There has been an intermittent issue with this task where it would fail and print the error:
  # 
  #     Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process
  #     using it?
  #
  # The reason for this is unclear. It's not from unattended-upgrades as that has already been
  # uninstalled when creating the base image. The workaround for now is to simply retry this task
  # several times in the event that it fails, with a small delay between each attempt.
  register: result
  until: result is not failed
  retries: 5
  delay: 5

- name: Docker - Add Docker's official GPG Key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Docker - Setup Stable Repository
  apt_repository:
    repo: "deb [arch={{ deb_architecture.stdout }}] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"

- name: Docker - install Docker
  apt:
    name: 
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: latest
    update_cache: yes
  # https://github.com/ansible/ansible/issues/51663#issuecomment-650562476
  # There has been an intermittent issue with this task where it would fail and print the error:
  # 
  #     Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process
  #     using it?
  #
  # The reason for this is unclear. It's not from unattended-upgrades as that has already been
  # uninstalled when creating the base image. The workaround for now is to simply retry this task
  # several times in the event that it fails, with a small delay between each attempt.
  register: result
  until: result is not failed
  retries: 5
  delay: 5

- name: Docker - Create the docker group
  group:
    name: docker
    state: present

- name: Docker - Add users to the group
  user:
    name: "{{ username_on_host.stdout }}"
    groups: ["docker"]
    append: yes

- name: Activate changes to docker group
  become: false
  command: newgrp docker

- name: Set Docker Compose variables
  set_fact:
    docker_compose_version: "1.29.2"
    docker_compose_path: /usr/local/bin/docker-compose

- name: Docker - Check current docker-compose version.
  command: docker-compose --version
  register: docker_compose_current_version
  changed_when: false
  failed_when: false

- name: Docker - Delete existing docker-compose version if it's different.
  file:
    path: "{{ docker_compose_path }}"
    state: absent
  when: >
    docker_compose_current_version.stdout is defined
    and docker_compose_version not in docker_compose_current_version.stdout

- name: Docker - Install Docker Compose (if configured).
  get_url:
    url: "https://github.com/docker/compose/releases/download/\
          {{ docker_compose_version }}/docker-compose-{{ unames.stdout }}-{{ ansible_architecture }}"
    dest: "{{ docker_compose_path }}"
    mode: 0755
